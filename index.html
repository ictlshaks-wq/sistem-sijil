<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Janaan Sijil Pintar - JPN Pahang</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Cinzel:wght@600&family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- html2pdf (html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --primary-blue:#2c3e50;
      --gold-accent:#bc9355;
      --bg-light:#f4f7f6;
    }

    body{
      background:var(--bg-light);
      padding:20px 0;
      font-family:'Montserrat',sans-serif;
    }

    /* Kad input */
    .input-card{
      max-width:560px;
      background:#fff;
      padding:28px;
      border-radius:16px;
      box-shadow:0 10px 25px rgba(0,0,0,.10);
      margin:18px auto;
    }

    .form-label{ font-weight:800; color:var(--primary-blue); }

    /* Pratonton */
    #certificate-container{ display:none; margin-top:26px; }

    .cert-viewport{
      overflow-x:auto;
      background:#d1d5db;
      padding:28px 10px;
      border-radius:12px;
      display:flex;
      justify-content:center;
      box-shadow:inset 0 2px 10px rgba(0,0,0,.12);
    }

    /* A4 portrait pada skrin (px) */
    #actual-certificate{
      width:793px;
      height:1122px;
      padding:70px 80px;
      background:#fff;
      border:22px solid var(--primary-blue);
      outline:6px solid var(--gold-accent);
      outline-offset:-32px;
      position:relative;
      text-align:center;
      color:#333;
      background-image:radial-gradient(circle,#ffffff 0%, #fdfbf7 100%);
      box-sizing:border-box;

      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }

    .logo-box{
      height:140px;
      display:flex;
      justify-content:center;
      align-items:center;
      margin-top:10px;
      z-index:2;
    }

    /* IMPORTANT: display:block & max sizes untuk elak hilang */
    .logo-img{
      max-height:120px;
      width:auto;
      display:block;
      object-fit:contain;
    }

    .cert-header-title{
      font-family:'Cinzel',serif;
      font-size:52px;
      color:var(--gold-accent);
      margin-top:8px;
      letter-spacing:4px;
      line-height:1.1;
      z-index:2;
    }

    .cert-body{
      flex-grow:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      z-index:2;
      padding:20px 0;
    }

    .text-intro{ font-size:24px; margin-bottom:14px; }

    .participant-name{
      font-family:'Great Vibes',cursive;
      font-size:76px;
      color:var(--primary-blue);
      margin:18px 0;
      border-bottom:3px solid var(--gold-accent);
      display:inline-block;
      min-width:90%;
      text-transform:uppercase;
      padding-bottom:6px;
    }

    .text-participation{ font-size:22px; margin:14px 0; }
    .program-name{
      font-weight:800;
      color:var(--primary-blue);
      font-size:32px;
      line-height:1.25;
      text-transform:uppercase;
    }
    .program-details{
      font-size:18px;
      color:#555;
      margin-top:14px;
      font-weight:400;
    }

    .signature-area{
      margin-bottom:50px;
      display:flex;
      flex-direction:column;
      align-items:center;
      z-index:2;
    }

    .signature-img{
      height:100px;
      width:auto;
      display:block;
      object-fit:contain;
      margin-bottom:-25px;
      z-index:5;
    }

    .signature-line{
      border-top:2px solid #333;
      width:400px;
      padding-top:12px;
    }

    .signer-name{
      font-weight:800;
      font-size:20px;
      text-transform:uppercase;
      margin-bottom:2px;
    }

    .signer-title{
      font-size:16px;
      color:#444;
      line-height:1.3;
    }

    .watermark{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%) rotate(-45deg);
      font-size:180px;
      color:rgba(188,147,85,0.04);
      font-family:'Cinzel',serif;
      z-index:1;
      pointer-events:none;
      user-select:none;
      white-space:nowrap;
    }

    .spinner-border{ width:1.2rem; height:1.2rem; display:none; margin-right:8px; }

    .btn-success{
      padding:12px 40px;
      font-weight:800;
      border-radius:10px;
    }

    /* Skala skrin kecil */
    @media (max-width:850px){
      #actual-certificate{ transform:scale(.6); transform-origin:top center; }
      .cert-viewport{ height:760px; }
    }
    @media (max-width:500px){
      #actual-certificate{ transform:scale(.4); transform-origin:top center; }
      .cert-viewport{ height:520px; }
    }
  </style>
</head>

<body>
<div class="container">

  <!-- BORANG -->
  <div class="input-card">
    <h4 class="text-center mb-3" style="color:var(--primary-blue);">Sistem Sijil Digital JPN Pahang</h4>

    <div class="alert alert-info py-2 text-center small mb-3">
      Kod demo: <strong>DEMO123</strong>
    </div>

    <div id="statusMsg" class="small text-center mb-3" style="min-height:18px;color:#0f766e;"></div>

    <div class="mb-3">
      <label class="form-label">Nama Penuh Peserta</label>
      <input type="text" id="inputNama" class="form-control" placeholder="SEPERTI DALAM KAD PENGENALAN" />
    </div>

    <div class="mb-3">
      <label class="form-label">Nombor Kad Pengenalan</label>
      <input type="text" id="inputIC" class="form-control" placeholder="CONTOH: 010203060708" />
      <div class="form-text">Tip: boleh tanpa dash (-). Sistem paparkan seperti dimasukkan.</div>
    </div>

    <div class="mb-3">
      <label class="form-label text-danger">Kod Rahsia Program</label>
      <input type="text" id="inputKod" class="form-control" placeholder="Masukkan kod daripada penganjur" />
    </div>

    <button onclick="janaSijilSekarang()" id="btnJana"
      class="btn btn-primary w-100 py-2 d-flex align-items-center justify-content-center">
      <div class="spinner-border text-light" role="status" id="loading"></div>
      <span id="btnText">Semak & Jana Sijil</span>
    </button>
  </div>

  <!-- SIJIL -->
  <div id="certificate-container" class="text-center">
    <hr class="my-5">

    <div class="cert-viewport">
      <div id="actual-certificate" class="shadow-lg">

        <!-- LOGO (LOCAL) -->
        <div class="logo-box">
          <img src="./assets/logo.png" class="logo-img" alt="Logo JPN">
        </div>

        <div class="watermark">RASMI</div>

        <div class="cert-header">
          <div class="cert-header-title">SIJIL<br>PENYERTAAN</div>
        </div>

        <div class="cert-body">
          <div class="text-intro">Dengan penuh sukacita diperakui bahawa</div>
          <div class="participant-name" id="displayNama">NAMA PESERTA</div>
          <div class="text-intro">No. K/P: <span id="displayIC">000000-00-0000</span></div>

          <div class="mt-4">
            <div class="text-participation">telah menyertai dengan jayanya program</div>
            <div class="program-name" id="displayProgram">NAMA PROGRAM</div>
            <div class="program-details" id="displayMeta">Tarikh | Masa | Tempat</div>
          </div>
        </div>

        <!-- TANDATANGAN (LOCAL) -->
        <div class="signature-area">
          <img src="./assets/sign.png" class="signature-img" alt="Tandatangan">
          <div class="signature-line">
            <div class="signer-name">PENGARAH PENDIDIKAN NEGERI PAHANG</div>
            <div class="signer-title">Jabatan Pendidikan Negeri Pahang</div>
          </div>
        </div>

      </div>
    </div>

    <div class="mt-4 mb-5 pb-5">
      <button onclick="downloadSijilPDF()" class="btn btn-success btn-lg shadow">
        MUAT TURUN SIJIL (PDF A4)
      </button>
      <p class="mt-3 text-muted small fst-italic">
        Nota: Versi ini guna imej local (./assets). Sangat stabil untuk paparan & PDF.
      </p>
    </div>
  </div>

</div>

<script>
  // ======================
  // DATA DEMO
  // ======================
  const dataDemo = [{
    kod: "DEMO123",
    program: "BENGKEL TRANSFORMASI DIGITAL & AI 2026",
    tarikh: "20 Januari 2026",
    masa: "8.30 Pagi - 4.30 Petang",
    tempat: "Pusat Konvensyen JPN Pahang"
  }];

  // ======================
  // (OPTIONAL) REAL-TIME
  // Jika anda ada Apps Script, letak URL web app di sini.
  // Kalau tak, biarkan kosong (demo sahaja).
  // ======================
  const SCRIPT_URL = ""; // contoh: "https://script.google.com/macros/s/AKfycb.../exec";

  function setStatus(msg, color="#0f766e"){
    const el = document.getElementById("statusMsg");
    el.style.color = color;
    el.textContent = msg || "";
  }

  function normalizeKod(x){
    return (x || "").toString().trim().toUpperCase();
  }

  function basicICOk(ic){
    const clean = (ic || "").replace(/[^0-9]/g, "");
    return clean.length >= 8 && clean.length <= 14;
  }

  async function janaSijilSekarang(){
    const kod  = document.getElementById("inputKod").value.trim();
    const nama = document.getElementById("inputNama").value.trim();
    const ic   = document.getElementById("inputIC").value.trim();

    const btn = document.getElementById("btnJana");
    const spinner = document.getElementById("loading");
    const btnText = document.getElementById("btnText");

    if(!nama || !ic || !kod){
      alert("Sila lengkapkan Nama, IC dan Kod Program.");
      return;
    }
    if(!basicICOk(ic)){
      alert("Format IC nampak tidak sah. Sila semak semula.");
      return;
    }

    setStatus("");
    btn.disabled = true;
    spinner.style.display = "inline-block";
    btnText.textContent = "Menjana...";
    document.getElementById("certificate-container").style.display = "none";

    // DEMO
    if(normalizeKod(kod) === "DEMO123"){
      setTimeout(() => {
        const d = dataDemo[0];
        tampilkanSijil(
          nama, ic,
          d.program,
          `${d.tarikh} | ${d.masa} | ${d.tempat}`
        );
        btn.disabled = false;
        spinner.style.display = "none";
        btnText.textContent = "Semak & Jana Sijil";
        setStatus("Sijil demo berjaya dijana.");
      }, 350);
      return;
    }

    // REAL-TIME (Apps Script) - optional
    try{
      if(!SCRIPT_URL){
        alert("Mod real-time belum diaktifkan. Guna kod DEMO123 untuk ujian, atau masukkan SCRIPT_URL.");
        setStatus("SCRIPT_URL kosong. Aktifkan Apps Script jika mahu mod real-time.", "#b45309");
        return;
      }

      setStatus("Menyemak kod program...");
      const url = `${SCRIPT_URL}?kod=${encodeURIComponent(kod)}`;
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);

      const out = await res.json();

      if(out && out.ok && out.program){
        const p = out.program;
        tampilkanSijil(
          nama, ic,
          p.nama_program || "NAMA PROGRAM",
          `Tarikh: ${p.tarikh || "-"} | Masa: ${p.masa || "-"} | Tempat: ${p.tempat || "-"}`
        );
        setStatus("Kod sah. Sijil berjaya dijana.");
      }else{
        alert((out && out.message) ? out.message : "Kod Rahsia tidak dijumpai.");
        setStatus("Kod tidak dijumpai.", "#b45309");
      }
    }catch(e){
      console.error(e);
      alert("Ralat sambungan / konfigurasi Apps Script.");
      setStatus("Ralat sambungan / konfigurasi Apps Script.", "#b91c1c");
    }finally{
      btn.disabled = false;
      spinner.style.display = "none";
      btnText.textContent = "Semak & Jana Sijil";
    }
  }

  function tampilkanSijil(nama, ic, program, meta){
    document.getElementById("displayNama").innerText = (nama || "").toUpperCase();
    document.getElementById("displayIC").innerText = ic || "";
    document.getElementById("displayProgram").innerText = program || "";
    document.getElementById("displayMeta").innerText = meta || "";

    document.getElementById("certificate-container").style.display = "block";
    window.scrollTo({ top: document.getElementById("certificate-container").offsetTop, behavior:"smooth" });
  }

  function downloadSijilPDF(){
    const element = document.getElementById("actual-certificate");
    const namaPeserta = (document.getElementById("displayNama").innerText || "Peserta").replace(/\s+/g,"_");

    // PENTING:
    // - bila guna file local + imej local, tak perlu CORS.
    // - allowTaint true membantu bila browser ketat.
    const opt = {
      margin: 0,
      filename: `Sijil_${namaPeserta}.pdf`,
      image: { type: "jpeg", quality: 1 },
      html2canvas: {
        scale: 3,
        backgroundColor: "#ffffff",
        useCORS: false,
        allowTaint: true,
        scrollX: 0,
        scrollY: 0,
        windowWidth: 793,
        windowHeight: 1122
      },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };

    html2pdf().set(opt).from(element).save();
  }
</script>
</body>
</html>

