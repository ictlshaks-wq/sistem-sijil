<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Janaan Sijil Pintar - JPN Pahang</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- html2pdf (html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --primary-blue:#0B3A74;
      --gold-accent:#bc9355;
      --bg-light:#eef2f7;
    }

    body{
      background:var(--bg-light);
      padding:20px 0;
      font-family:'Montserrat',sans-serif;
    }

    /* Kad input */
    .input-card{
      max-width:560px;
      background:#fff;
      padding:28px;
      border-radius:16px;
      box-shadow:0 10px 25px rgba(0,0,0,.10);
      margin:18px auto;
    }
    .form-label{ font-weight:800; color:var(--primary-blue); }

    /* Container sijil */
    #certificate-container{ display:none; margin-top:26px; }

    .cert-viewport{
      overflow:auto;
      background:#d1d5db;
      padding:22px 10px;
      border-radius:12px;
      display:flex;
      justify-content:center;
      box-shadow:inset 0 2px 10px rgba(0,0,0,.12);
    }

    /* ====== SIJIL A4 PORTRAIT (MM) ====== */
    #actual-certificate{
      width:210mm;
      height:297mm;
      box-sizing:border-box;
      background:#fff;
      position:relative;
      text-align:center;
      color:#111;

      /* border buang */
      border:0;
      outline:0;
      outline-offset:0;

      padding:18mm 18mm 20mm 18mm;
      background-image:radial-gradient(circle,#ffffff 0%, #fdfbf7 100%);

      /* elak extra page */
      overflow:hidden;
      box-shadow:none;
      transform:none;
    }

    /* Preview scaling */
    #certScaleWrap{ transform-origin: top center; }

    .logo-box{
      height:28mm;
      display:flex;
      justify-content:center;
      align-items:center;
      margin-top:2mm;
      position:relative;
      z-index:2;
    }
    .logo-img{
      /* ✅ Logo kecil 30% (dari 33mm -> ~23mm) */
      max-height:30mm;
      width:auto;
      display:block;
      object-fit:contain;
    }

    .cert-header-title{
      font-family:'Cinzel',serif;
      font-size:20mm;
      color:var(--gold-accent);
      margin-top:2mm;
      letter-spacing:2.5mm;
      line-height:1.05;
      position:relative;
      z-index:2;
      text-transform:uppercase;
    }

    .cert-body{
      margin-top:8mm;
      position:relative;
      z-index:2;
    }

    .text-intro{
      font-size:5mm;
      margin-bottom:5mm;
    }

    .participant-name{
      font-family:'Cinzel',serif;
      font-weight:800;
      font-size:9mm;
      color:#000;
      margin:6mm 0 4mm 0;
      text-transform:uppercase;
      letter-spacing:0.7mm;
      padding-bottom:2.5mm;
      border-bottom:0.8mm solid var(--gold-accent);
      display:inline-block;
      width:100%;
    }

    .ic-text{
      font-size:4.7mm;
      margin-top:2mm;
      margin-bottom:8mm;
    }

    .text-participation{
      font-size:5mm;
      margin:4mm 0 3mm 0;
    }

    .program-name{
      font-family:'Cinzel',serif;
      font-weight:800;
      color:#0b1f3b;
      font-size:9mm;
      line-height:1.25;
      text-transform:uppercase;
      letter-spacing:0.6mm;
      margin:0;
    }

    .program-details{
      font-size:4.4mm;
      color:#444;
      margin-top:5mm;
    }

    /* TANDATANGAN */
    .signature-area{
      position:absolute;
      left:0;
      right:0;
      bottom:10mm;
      display:flex;
      flex-direction:column;
      align-items:center;
      z-index:2;
    }

    .signature-img{
      /* ✅ Tandatangan besar 80%: 18mm -> 32.4mm */
      height:48mm;
      width:auto;
      display:block;
      object-fit:contain;
      margin-bottom:-6mm;
    }

.signature-line{
  border-top:0.5mm solid #111;
  width:90mm;
  margin-left:auto;
  margin-right:auto;
  padding-top:3mm;
  text-align:center;
}


.signer-name{
  font-weight:800;
  font-size:4.5mm;
  text-transform:uppercase;
  margin-bottom:1mm;

  text-align:center;
  white-space:nowrap;
}



.signer-title{
  font-size:3.8mm;
  color:#333;
  line-height:1.25;
  text-align:center;
}


    .watermark{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%) rotate(-35deg);
      font-size:40mm;
      color:rgba(188,147,85,0.06);
      font-family:'Cinzel',serif;
      z-index:1;
      pointer-events:none;
      user-select:none;
      white-space:nowrap;
      text-transform:uppercase;
    }

    .spinner-border{ width:1.2rem; height:1.2rem; display:none; margin-right:8px; }
    .btn-success{ padding:12px 40px; font-weight:800; border-radius:10px; }

    @page { size: A4 portrait; margin: 0; }
    @media print{
      body{ background:#fff; padding:0; }
      .input-card, .cert-viewport, .btn, hr, p { display:none !important; }
      #certificate-container{ display:block !important; }
      #actual-certificate{ box-shadow:none !important; }
    }
  </style>
</head>

<body>
<div class="container">

  <!-- BORANG -->
  <div class="input-card">
    <h4 class="text-center mb-3" style="color:var(--primary-blue);">Sistem Sijil Digital JPN Pahang</h4>

    <div id="statusMsg" class="small text-center mb-3" style="min-height:18px;color:#0f766e;"></div>

    <div class="mb-3">
      <label class="form-label">Nama Penuh Peserta</label>
      <input type="text" id="inputNama" class="form-control" placeholder="SEPERTI DALAM KAD PENGENALAN" />
    </div>

    <div class="mb-3">
      <label class="form-label">Nombor Kad Pengenalan</label>
      <input type="text" id="inputIC" class="form-control" placeholder="CONTOH: 010203060708" />
      <div class="form-text">Tip: boleh tanpa dash (-). Sistem paparkan seperti dimasukkan.</div>
    </div>

    <div class="mb-3">
      <label class="form-label text-danger">Kod Program</label>
      <input type="text" id="inputKod" class="form-control" placeholder="Masukkan kod daripada penganjur" />
      <div class="form-text">Sistem akan baca Nama Program, Tarikh dan Tempat dari Google Sheet berdasarkan kod ini.</div>
    </div>

    <button onclick="janaSijilSekarang()" id="btnJana"
      class="btn btn-primary w-100 py-2 d-flex align-items-center justify-content-center">
      <div class="spinner-border text-light" role="status" id="loading"></div>
      <span id="btnText">Semak & Jana Sijil</span>
    </button>
  </div>

  <!-- SIJIL -->
  <div id="certificate-container" class="text-center">
    <hr class="my-5">

    <div class="cert-viewport">
      <div id="certScaleWrap">
        <div id="actual-certificate">

          <!-- LOGO -->
          <div class="logo-box">
            <img src="assets/logo.png" class="logo-img" alt="Logo JPN" crossorigin="anonymous">
          </div>

          <div class="watermark">RASMI</div>

          <div class="cert-header">
            <div class="cert-header-title">SIJIL<br>PENYERTAAN</div>
          </div>

          <div class="cert-body">
            <div class="text-intro">Dengan penuh sukacita diperakui bahawa</div>

            <div class="participant-name" id="displayNama">NAMA PESERTA</div>

            <div class="ic-text">No. K/P: <span id="displayIC">000000000000</span></div>

            <div class="text-participation">telah menyertai dengan jayanya program</div>
            <div class="program-name" id="displayProgram">NAMA PROGRAM</div>
            <div class="program-details" id="displayMeta">Tarikh | Tempat</div>
          </div>

          <!-- TANDATANGAN -->
          <div class="signature-area">
            <img src="assets/sign.png" class="signature-img" alt="Tandatangan" crossorigin="anonymous">
            <div class="signature-line">
              <div class="signer-name">HAJI AHMAD ZAMRI BIN MD ISA</div>
              <div class="signer-name">PENGARAH PENDIDIKAN NEGERI PAHANG</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="mt-4 mb-5 pb-5">
      <button type="button" onclick="downloadSijilPDF()" class="btn btn-success btn-lg shadow">
        MUAT TURUN SIJIL (PDF A4)
      </button>
    </div>
  </div>

</div>

<script>
  // ✅ LETAK URL WEB APP APPS SCRIPT ANDA DI SINI
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNUQXAQmupInbQEPgVpRa3jWxanslou8PlYtYzSCZuRtJi5HjR-vA-mlVjKL0ab3i1/exec"; // contoh: "https://script.google.com/macros/s/XXXX/exec"

  function setStatus(msg, color="#0f766e"){
    const el = document.getElementById("statusMsg");
    el.style.color = color;
    el.textContent = msg || "";
  }

  function normalizeKod(x){
    return (x || "").toString().trim().toUpperCase();
  }

  function basicICOk(ic){
    const clean = (ic || "").replace(/[^0-9]/g, "");
    return clean.length >= 8 && clean.length <= 14;
  }

  // Auto scale preview
  function fitPreview(){
    const wrap = document.getElementById("certScaleWrap");
    const cert = document.getElementById("actual-certificate");
    const viewport = document.querySelector(".cert-viewport");
    if(!wrap || !cert || !viewport) return;

    const padding = 30;
    const available = viewport.clientWidth - padding;
    const certPxWidth = cert.getBoundingClientRect().width;
    let scale = available / certPxWidth;
    if(scale > 1) scale = 1;
    if(scale < 0.25) scale = 0.25;
    wrap.style.transform = `scale(${scale})`;
  }

  window.addEventListener("resize", () => {
    if(document.getElementById("certificate-container").style.display === "block") fitPreview();
  });

  async function janaSijilSekarang(){
    const kod  = document.getElementById("inputKod").value.trim();
    const nama = document.getElementById("inputNama").value.trim();
    const ic   = document.getElementById("inputIC").value.trim();

    const btn = document.getElementById("btnJana");
    const spinner = document.getElementById("loading");
    const btnText = document.getElementById("btnText");

    if(!nama || !ic || !kod){
      alert("Sila lengkapkan Nama, IC dan Kod Program.");
      return;
    }
    if(!basicICOk(ic)){
      alert("Format IC nampak tidak sah. Sila semak semula.");
      return;
    }

    if(!SCRIPT_URL){
      alert("SCRIPT_URL belum diisi. Sila tampal URL Web App Apps Script.");
      return;
    }

    setStatus("");
    btn.disabled = true;
    spinner.style.display = "inline-block";
    btnText.textContent = "Menyemak kod...";
    document.getElementById("certificate-container").style.display = "none";

    try{
      setStatus("Menyemak kod program...");

      const url = `${SCRIPT_URL}?kod=${encodeURIComponent(normalizeKod(kod))}`;
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);

      const out = await res.json();

      if(out && out.ok && out.program){
        const p = out.program;

        tampilkanSijil(
          nama,
          ic,
          p.nama_program || "NAMA PROGRAM",
          `${p.tarikh || "-"} | ${p.tempat || "-"}`
        );

        setStatus("Kod sah. Sijil berjaya dijana.");
      } else {
        alert((out && out.message) ? out.message : "Kod program tidak dijumpai.");
        setStatus("Kod tidak dijumpai.", "#b45309");
      }
    } catch(e){
      console.error(e);
      alert("Ralat sambungan / konfigurasi Apps Script.");
      setStatus("Ralat sambungan / konfigurasi Apps Script.", "#b91c1c");
    } finally {
      btn.disabled = false;
      spinner.style.display = "none";
      btnText.textContent = "Semak & Jana Sijil";
    }
  }

  function tampilkanSijil(nama, ic, program, meta){
    document.getElementById("displayNama").innerText = (nama || "").toUpperCase();
    document.getElementById("displayIC").innerText = (ic || "").replace(/\s+/g,"");
    document.getElementById("displayProgram").innerText = (program || "").toUpperCase();
    document.getElementById("displayMeta").innerText = meta || "";

    const container = document.getElementById("certificate-container");
    container.style.display = "block";

    setTimeout(() => {
      fitPreview();
      window.scrollTo({ top: container.offsetTop, behavior:"smooth" });
    }, 50);
  }

  async function downloadSijilPDF(){
    const cert = document.getElementById("actual-certificate");
    const wrap = document.getElementById("certScaleWrap");
    const namaPeserta = (document.getElementById("displayNama").innerText || "Peserta").replace(/\s+/g,"_");

    if(!cert){
      alert("Ralat: sijil tidak dijumpai.");
      return;
    }

    const btn = document.querySelector('button[onclick="downloadSijilPDF()"]');
    const oldBtnText = btn ? btn.innerText : "";
    if(btn){ btn.disabled = true; btn.innerText = "Sedang jana PDF..."; }

    try{
      // font siap
      if(document.fonts && document.fonts.ready){
        try { await document.fonts.ready; } catch(e){}
      }

      // imej siap
      const imgs = Array.from(cert.querySelectorAll("img"));
      await Promise.all(imgs.map(img => new Promise(resolve => {
        if(img.complete && img.naturalWidth > 0) return resolve(true);
        img.onload = () => resolve(true);
        img.onerror = () => resolve(true);
      })));

      // matikan transform preview sementara
      const oldTransform = wrap ? wrap.style.transform : "";
      if(wrap) wrap.style.transform = "none";

      const opt = {
        margin: 0,
        filename: `Sijil_${namaPeserta}.pdf`,
        image: { type: "jpeg", quality: 1 },
        html2canvas: {
          scale: 3,
          backgroundColor: "#ffffff",
          useCORS: true,
          allowTaint: true,
          logging: false,
          scrollX: 0,
          scrollY: 0
        },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      const worker = html2pdf().set(opt).from(cert).toPdf();

      // ✅ pastikan tinggal 1 page sahaja
      await worker.get("pdf").then((pdf) => {
        let total = pdf.internal.getNumberOfPages();
        while(total > 1){
          pdf.deletePage(total);
          total = pdf.internal.getNumberOfPages();
        }
      });

      await worker.save();

      // restore transform
      if(wrap) wrap.style.transform = oldTransform;

    } catch(err){
      console.error(err);
      alert("Ralat semasa menjana PDF. Sila cuba semula.");
    } finally {
      if(btn){ btn.disabled = false; btn.innerText = oldBtnText || "MUAT TURUN SIJIL (PDF A4)"; }
    }
  }
</script>
</body>
</html>











